% blockram version
% convolution kernel 17x17
function drow = FarnebackPolyExp (src)
%--------------------------------------------
width  = 200;
height = 200;
n = 8;
%--------------------------------------------
row  = zeros((width + n*2)*3+24+ n*3);
g    = zeros(n*6 + 3 + n);
xg   = zeros(n*6 + 3 + n + n*2 + 1);
xxg  = zeros(n*6 + 3 + n + n*2 + 1 + n*2 + 1);
G    = zeros(6,6);
drow  = zeros(height,width*5);
%--------------------------------------------
g( 1) = 7.425750567660737e-11;  xg( 1) = -5.940600454128590e-10; xxg( 1) = 4.752480363302872e-09;
g( 2) = 1.357346656654903e-08;  xg( 2) = -9.501426596584319e-08; xxg( 2) = 6.650998617609023e-07;
g( 3) = 1.238932971502896e-06;  xg( 3) = -7.433597829017376e-06; xxg( 3) = 4.460158697410425e-05;
g( 4) = 5.646917756715771e-05;  xg( 4) = -2.823458878357885e-04; xxg( 4) = 0.001411729439179;
g( 5) = 0.001285225836022;      xg( 5) = -0.005140903344087;     xxg( 5) = 0.020563613376348;
g( 6) = 0.014606906292119;      xg( 6) = -0.043820718876357;     xxg( 6) = 0.131462156629071;
g( 7) = 0.082897614969052;      xg( 7) = -0.165795229938103;     xxg( 7) = 0.331590459876207;
g( 8) = 0.234926576512800;      xg( 8) = -0.234926576512800;     xxg( 8) = 0.234926576512800;
g( 9) = 0.332451909263490;      xg( 9) = 0.0;                    xxg( 9) = 0.0;
g(10) = 0.234926576512800;      xg(10) = 0.234926576512800;      xxg(10) = 0.234926576512800;
g(11) = 0.082897614969052;      xg(11) = 0.165795229938103;      xxg(11) = 0.331590459876207;
g(12) = 0.014606906292119;      xg(12) = 0.043820718876357;      xxg(12) = 0.131462156629071;
g(13) = 0.001285225836022;      xg(13) = 0.005140903344087;      xxg(13) = 0.020563613376348;
g(14) = 5.646917756715771e-05;  xg(14) = 2.823458878357885e-04;  xxg(14) = 0.001411729439179;
g(15) = 1.238932971502896e-06;  xg(15) = 7.433597829017376e-06;  xxg(15) = 4.460158697410425e-05;
g(16) = 1.357346656654903e-08;  xg(16) = 9.501426596584319e-08;  xxg(16) = 6.650998617609023e-07;
g(17) = 7.425750567660737e-11;  xg(17) = 5.940600454128590e-10;  xxg(17) = 4.752480363302872e-09;
ig11 = 0.6944; ig03 = -0.3472; ig33 = 0.2411; ig55 = 0.4823;

for y2 = 0: height-1
	% v convolution
    %-------------------------------------------- pipe1
	for x4 = 0: width-1
	    row(x4*3+25) = double(src(y2+1,x4+1))*g(9);
		row(x4*3+26) = 0.0;
		row(x4*3+27) = 0.0;
	end
	%-------------------------------------------- pipe2
	for k = 1: n
	    g0 = g(k+9);
		g1 = xg(k+9);
		g2 = xxg(k+9);
	    for x5 = 0: width-1
		    srow_0 = src(max(y2-k,1)+1,x5+1);
			srow_1 = src(min(y2+k,height-1)+1,x5+1);
			linebuf(x*k + x)
			
			p = int16(srow_1) + int16(srow_0);
            q = int16(srow_1) - int16(srow_0);
            
			t0 = row(x5*3+25) + g0 * double(p);
			t1 = row(x5*3+26) + g1 * double(q);
	        t2 = row(x5*3+27) + g2 * double(p);
		
			row(x5*3+25) = t0;
	        row(x5*3+26) = t1;
	        row(x5*3+27) = t2;
	    end
	end
	
	% h convolution
    %-------------------------------------------- pipe3
	for x6 = 0: n*3-1
	    row(x6+25) = row(2-x6+25);
        row(width*3+x6+25) = row(width*3+x6-3+25);
	end 
	%-------------------------------------------- pipe4
	for x7 = 0: width-1
	    g0 = g(9);
        b1 = row(x7*3+25)*g0;
        b2 = 0.0;
        b3 = row(x7*3+26)*g0;
        b4 = 0.0;
        b5 = row(x7*3+27)*g0;
        b6 = 0.0;
		for k = 1: n
		    tg = row((x7+k)*3+25) + row((x7-k)*3+25);
            g0 = g(k+9);
            b1 = b1 + tg*g0;
            b4 = b4 + tg*xxg(k+9);
            b2 = b2 + (row((x7+k)*3  +25) - row((x7-k)*3  +25))*xg(k+9);
            b3 = b3 + (row((x7+k)*3+1+25) + row((x7-k)*3+1+25))*g0;
            b6 = b6 + (row((x7+k)*3+1+25) - row((x7-k)*3+1+25))*xg(k+9);
            b5 = b5 + (row((x7+k)*3+2+25) + row((x7-k)*3+2+25))*g0;
		end 
		drow(y2+1,x7*5+2) = b2*ig11;
	    drow(y2+1,x7*5+1) = b3*ig11;
	    drow(y2+1,x7*5+4) = b1*ig03 + b4*ig33;
	    drow(y2+1,x7*5+3) = b1*ig03 + b5*ig33;
	    drow(y2+1,x7*5+5) = b6*ig55;
	end
    %--------------------------------------------
end 